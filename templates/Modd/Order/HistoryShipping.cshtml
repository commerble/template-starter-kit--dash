@{
    var shipping = Page.ViewData.Model as VM.HistoryShipping;
    var viewData = Page.ViewData[BasicController.ViewMessageKey] as ViewMessages;

    ViewBag.MetaTitle = "注文編集 - お届け先";
}
<main class="section content">
    <h1 class="h-underline">お届け先</h1>
    @DisplayViewMessages(viewData)
    <form action="@HistoryShippingUrl(shipping.Cart.OrderId)" method="post">
        @Page.Html.HttpMethodOverride("put")
        <dl class="field required">
            <dt class="field-title">お届け先選択</dt>
            <dd class="field-body">
                @if(!shipping.IsAnonymous) {
                    @:@Page.Html.DropDownList("DeliveryOrderAddress.AddressId", shipping.MemberAddressList.ToSelectListItems(shipping.IsAnonymous, shipping.DeliveryOrderAddress.AddressId), new {
                        ic_action="selectAddress" 
                    })
                }
            </dd>
        </dl>
        @Page.Html.PartialEx("ModdSharedAddressEditor", shipping.DeliveryOrderAddress, new {
            target = "DeliveryOrderAddress", 
            command = "zipsearch", 
            commandUrl = HistoryShippingUrl(shipping.Cart.OrderId),
            commandMethod = "put"
        })
        <div class="block block-vertical">
            <button type="submit" class="btn btn-action btn-large btn-next" name="shipping" value="put">お届け先を変更</button>
            <a href="@HistoryUrl(shipping.Cart.OrderId)" class="btn btn-primary btn-text btn-prev">注文詳細へもどる</a>
        </div>
    </form>
</main>

@section ScriptBlock {
<script>
    (function() {
        var addrs = @Raw(shipping.MemberAddressList.ToJson(shipping.IsAnonymous));
        $.fn.selectAddress = function () {
            var id = $(this).val();
            var addr = addrs.find(a => a.AddressId+"" == id);
                
            if(addr == null)
                return;
                
            $("#DeliveryOrderAddress_Recipientfirstname").val(addr.Recipientfirstname || "");
            $("#DeliveryOrderAddress_Recipientlastname").val(addr.Recipientlastname || "");
            $("#DeliveryOrderAddress_Recipientfirstnamekana").val(addr.Recipientfirstnamekana || "");
            $("#DeliveryOrderAddress_Recipientlastnamekana").val(addr.Recipientlastnamekana || "");
            $("#DeliveryOrderAddress_ZipCode").val(addr.ZipCode || "");
            $("#DeliveryOrderAddress_Pref").val(addr.Pref || "");
            $("#DeliveryOrderAddress_City").val(addr.City || "");
            $("#DeliveryOrderAddress_Street").val(addr.Street || "");
            $("#DeliveryOrderAddress_Building").val(addr.Building || "");
            $("#DeliveryOrderAddress_Tel").val(addr.Tel || "");
        }
    }())
</script>
}